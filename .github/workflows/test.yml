name: Tests

on:
  push:
    branches: [main]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    container:
      image: openresty/openresty:1.27.1.2-1-bullseye-fat@sha256:1899c4cbca2199cb2dc847e99e81ef2b5ab2345df0db247af2f391ad6f711994
      options: --init

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Install system dependencies
        run: |
          sed -i 's/^deb /deb [arch=amd64] /' /etc/apt/sources.list
          sed -i 's/$/ contrib/' /etc/apt/sources.list
          apt-get update
          apt-get install -y build-essential cpanminus libgd-dev libmaxminddb0 libmaxminddb-dev curl geoipupdate

      - name: Install Perl test dependencies
        run: cpanm -v --notest Test::Nginx TAP::Harness::Archive TAP::Formatter::JUnit

      - name: Install OPM packages
        run: |
          opm install ledgetech/lua-resty-http=0.17.1
          opm install openresty/lua-resty-dns=0.23
          opm install openresty/lua-resty-upload=0.10
          opm install bungle/lua-resty-reqargs=1.4
          opm install xiaooloong/lua-resty-iconv=0.2.0
          opm install anjia0532/lua-resty-maxminddb=1.3.7

      - name: Get current week number
        id: week
        run: echo "number=$(date +%Y-%W)" >> $GITHUB_OUTPUT

      - name: Cache MaxMind GeoLite2 databases
        id: cache-geoip
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5
        with:
          path: /var/lib/GeoIP
          # Cache key changes weekly (databases update Tues/Fri)
          key: geoip-${{ steps.week.outputs.number }}-${{ hashFiles('.github/Geoip.conf') }}

      - name: Download MaxMind GeoLite2 databases
        if: steps.cache-geoip.outputs.cache-hit != 'true'
        run: |
          cp .github/Geoip.conf /etc/GeoIP.conf
          echo "AccountID ${{ secrets.MAXMIND_ACCOUNT_ID }}" >> /etc/GeoIP.conf
          echo "LicenseKey ${{ secrets.MAXMIND_TOKEN }}" >> /etc/GeoIP.conf
          geoipupdate -v
          rm /etc/GeoIP.conf

      - name: OpenResty version
        run: openresty -V

      - name: Link OpenResty for tests
        run: ln -sf /usr/local/openresty/bin/openresty /usr/bin/nginx

      - name: Run tests
        run: |
          mkdir -p test-results/prove
          prove -r t -a test_results.tgz --formatter TAP::Formatter::JUnit > test-results/prove/results.xml

      - name: Upload test results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        if: always()
        with:
          name: test-results
          path: |
            test_results.tgz
            test-results/
