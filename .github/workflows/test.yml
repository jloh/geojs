name: Tests

on:
  push:
    branches: [main]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    container: openresty/openresty:1.27.1.2-1-bullseye-fat

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sed -i 's/^deb /deb [arch=amd64] /' /etc/apt/sources.list
          sed -i 's/$/ contrib/' /etc/apt/sources.list
          apt-get update
          apt-get install -y build-essential cpanminus libgd-dev libmaxminddb0 libmaxminddb-dev curl git geoipupdate

      - name: Install Perl test dependencies
        run: cpanm -v --notest Test::Nginx TAP::Harness::Archive TAP::Formatter::JUnit

      - name: Install OPM packages
        run: |
          opm install ledgetech/lua-resty-http=0.16.1
          opm install openresty/lua-resty-dns=0.21
          opm install openresty/lua-resty-upload=0.10
          opm install bungle/lua-resty-reqargs=1.4
          opm install xiaooloong/lua-resty-iconv=0.2.0
          opm install anjia0532/lua-resty-maxminddb=1.3.3

      - name: Download MaxMind GeoLite2 databases
        run: |
          cp .github/Geoip.conf /etc/GeoIP.conf
          echo "AccountID ${{ secrets.MAXMIND_ACCOUNT_ID }}" >> /etc/GeoIP.conf
          echo "LicenseKey ${{ secrets.MAXMIND_TOKEN }}" >> /etc/GeoIP.conf
          geoipupdate -v
          rm /etc/GeoIP.conf

      - name: Download MaxMind ASN Lua module
        run: |
          mkdir -p lib/resty
          curl -s -o lib/resty/maxminddb_asn.lua "${{ secrets.MAXMIND_LUA_URL }}"

      - name: OpenResty version
        run: openresty -V

      - name: Link OpenResty for tests
        run: ln -sf /usr/local/openresty/bin/openresty /usr/bin/nginx

      - name: Run tests
        run: |
          mkdir -p test-results/prove
          prove -r t -a test_results.tgz --formatter TAP::Formatter::JUnit > test-results/prove/results.xml

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            test_results.tgz
            test-results/

      - name: Publish test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Test Results
          path: test-results/prove/results.xml
          reporter: java-junit
