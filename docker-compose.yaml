services:
  # Download MaxMind GeoLite2 databases
  # Requires MAXMIND_ACCOUNT_ID and MAXMIND_LICENSE_KEY environment variables
  setup:
    build: .
    volumes:
      - ./:/opt/geojs
      - geoip-data:/var/lib/GeoIP
    environment:
      - MAXMIND_ACCOUNT_ID
      - MAXMIND_LICENSE_KEY
      - MAXMIND_LUA_URL
    entrypoint: ["/bin/bash"]
    command: ["/opt/geojs/scripts/setup.sh"]

  # Run tests
  tests:
    build: .
    init: true
    working_dir: /opt/geojs
    volumes:
      - ./:/opt/geojs
      - geoip-data:/var/lib/GeoIP:ro
    depends_on:
      setup:
        condition: service_completed_successfully

  # Interactive shell for debugging
  shell:
    build: .
    init: true
    working_dir: /opt/geojs
    stdin_open: true
    tty: true
    volumes:
      - ./:/opt/geojs
      - geoip-data:/var/lib/GeoIP:ro
    entrypoint: ["/bin/bash"]

volumes:
  geoip-data:
