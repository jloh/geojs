services:
  # Download MaxMind GeoLite2 databases
  # Requires MAXMIND_ACCOUNT_ID and MAXMIND_LICENSE_KEY environment variables
  setup:
    build: .
    volumes:
      - ./:/opt/geojs
      - geoip-data:/var/lib/GeoIP
    environment:
      - MAXMIND_ACCOUNT_ID
      - MAXMIND_LICENSE_KEY
      - MAXMIND_LUA_URL
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        if [ -z "$$MAXMIND_ACCOUNT_ID" ] || [ -z "$$MAXMIND_LICENSE_KEY" ]; then
          echo "Error: MAXMIND_ACCOUNT_ID and MAXMIND_LICENSE_KEY must be set"
          echo "Get free credentials at: https://www.maxmind.com/en/geolite2/signup"
          exit 1
        fi
        echo "Configuring geoipupdate..."
        printf '%s\n' "EditionIDs GeoLite2-City GeoLite2-Country GeoLite2-ASN" "AccountID $$MAXMIND_ACCOUNT_ID" "LicenseKey $$MAXMIND_LICENSE_KEY" > /etc/GeoIP.conf
        echo "Downloading MaxMind databases..."
        geoipupdate -v
        echo "Databases downloaded successfully to /var/lib/GeoIP"
        ls -la /var/lib/GeoIP/
        if [ -n "$$MAXMIND_LUA_URL" ]; then
          echo "Downloading MaxMind ASN Lua module..."
          mkdir -p /opt/geojs/lib/resty
          curl -s -o /opt/geojs/lib/resty/maxminddb_asn.lua "$$MAXMIND_LUA_URL"
        fi
        echo "Setup complete!"

  # Run tests
  tests:
    build: .
    init: true
    working_dir: /opt/geojs
    volumes:
      - ./:/opt/geojs
      - geoip-data:/var/lib/GeoIP:ro
    depends_on:
      setup:
        condition: service_completed_successfully

  # Interactive shell for debugging
  shell:
    build: .
    init: true
    working_dir: /opt/geojs
    stdin_open: true
    tty: true
    volumes:
      - ./:/opt/geojs
      - geoip-data:/var/lib/GeoIP:ro
    entrypoint: ["/bin/bash"]

volumes:
  geoip-data:
